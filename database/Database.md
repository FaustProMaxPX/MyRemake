# Database



## SQL



### Grammar

sqlæè¿°çš„æ˜¯æˆ‘éœ€è¦ä»€ä¹ˆï¼Œè€Œéæ€ä¹ˆåšã€‚åº•å±‚äº¤ç»™DBMSå®ç°ã€‚

> limit

limit [Integer]

æŸ¥æ‰¾è¡¨ä¸­å‰Integeræ¡è®°å½•ã€‚é€šå¸¸ä¸orderbyä¸€åŒä½¿ç”¨ã€‚



> group by

å°†è¡¨åˆ‡åˆ†æˆå¤šä¸ªç»„ï¼Œå¹¶ä»¥è¡¨ä¸ºå•ä½è¿›è¡Œç›¸å…³æ“ä½œã€‚

group byä¸å…è®¸ç›´æ¥æŸ¥è¯¢égroup byå‚æ•°çš„å­—æ®µã€‚

re: group byä¼šå°†è®¸å¤šè®°å½•ä½œä¸ºæ•´ä½“æ“ä½œï¼Œä½†égroup byå‚æ•°å­—æ®µåœ¨åˆ†ç±»åå…¶æ•°é‡åœ¨åŒä¸€ç»„ä¸­ä¹ŸåŠ¿å¿…>=1 æ— æ³•æˆä¸ºä¸€ä¸ªæ•´ä½“è¢«åæ˜ åˆ°è¡¨ä¸­ï¼Œå› æ­¤ä¸è¢«å…è®¸ã€‚

æ‰€æœ‰çš„èšåˆå‡½æ•°éƒ½éœ€è¦é’ˆå¯¹ä¸€ä¸ªç»„æ¥ä½¿ç”¨ï¼Œå¦‚æœä¸æ˜¾å¼æŒ‡æ˜ï¼Œåˆ™æ•´å¼ è¡¨ä½œä¸ºä¸€ä¸ªç»„ã€‚



Havingå¯¹æŸ¥è¯¢å‡ºçš„ç»„æ ¹æ®ç»™å®šæ¡ä»¶è¿›è¡Œè¿‡æ»¤ã€‚



> like

```sql
WHERE xxx LIKE 'B_%'
-- _ means any character. % means any number of that character

-- Regular expression
-- ~ means match
WHERE xxx ~ 'B.*'

```



> é›†åˆè¿ç®—

UNION: å–å¹¶é›†

INTERSECT: å–äº¤é›†

EXCEPT: å–å·®é›†

åŠ ä¸ŠALLä»£è¡¨æ˜¾ç¤ºé‡å¤å€¼ã€‚



> view

```sql
create view view_name
as select_statement
```

ä¸´æ—¶è§†å›¾

```sql
SELECT bname, scount
FROM Boats2 B,
(
	SELECT B.bid, COUNT(*)
    FROM R.bid = B.bid AND B.color = 'red'
    GROUP BY b.bid
) AS Reds(bid, scount)
WHERE Reds.bid = B.bid AND scount < 10

WITH tablename(columns...) AS (select_statement)
```





### Concept

> SQLæ‰§è¡Œæµç¨‹

```sql
SELECT DISTINCT target-list
FROM single table
WHERE qualification
GROUP BY grouping list
HAVING group-qualification
```



1. FROM  ç¡®è®¤è¦æŸ¥è¯¢çš„è¡¨
2. WHERE  ç­›é€‰æ»¡è¶³æ¡ä»¶çš„è®°å½•
3. SELECT  ä¿ç•™æ‰€éœ€è¦(å‡ºç°åœ¨SELECT/GROUP BY/ HAVING)çš„å­—æ®µ
4. GROUP BY  å½¢æˆéœ€è¦çš„ç»„
5. HAVING  ç­›é€‰æ»¡è¶³æ¡ä»¶çš„ç»„
6. DISTINCT  å»é™¤å†—ä½™çš„è®°å½•



> Division

 æŸ¥æ‰¾æ‹¥æœ‰æ‰€æœ‰èˆ¹åªçš„èˆ¹å‘˜ ==>  æŸ¥æ‰¾æ²¡æœ‰å“ªè‰˜èˆ¹ä¸æŒæœ‰çš„èˆ¹å‘˜

```sql
select s.sname
from Sailors s
where not exists (
	select B.bid
    from Boats b
    where not exists (
    	select R.id
        where R.bid = B.bid
        And R.sid = S.sid
    )
);
```



> NULL

NULLä»£è¡¨**ä¸ç¡®å®š**

æ‰€æœ‰ä¸NULLç›´æ¥è¿›è¡Œåˆ¤å®šçš„æ“ä½œéƒ½è¢«åˆ¤ä¸ºFalse

èšåˆå‡½æ•°ä¼šå¿½ç•¥å…¶æ‰€æœ‰æ“ä½œçš„å­—æ®µä¸­çš„NULLå€¼



## Hardware

### Disk

è®¿é—®çš„æ–¹å¼ä¸æ˜¯é€šè¿‡æŒ‡é’ˆè§£é™¤å¼•ç”¨ï¼Œè€Œæ˜¯å€ŸåŠ©API

READï¼šå°†ä¸€é¡µæ•°æ®ä»ç£ç›˜ç§»åˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡å†…å­˜çš„åœ°å€å¯¹ç£ç›˜è¿›è¡Œè®¿é—®

WRITEï¼šå°†ä¸€é¡µæ•°æ®ä»å†…å­˜å†™å…¥ç£ç›˜

æ³¨æ„APIè°ƒç”¨çš„é€Ÿåº¦éƒ½éå¸¸æ…¢ï¼Œéœ€è¦è‰¯å¥½çš„è§„åˆ’ã€‚



> è®¿é—®ä¸€ä¸ªé¡µçš„æ—¶é—´æ¶ˆè€—

æŸ¥æ‰¾ï¼šç£ç›˜è‡‚å°†ç£å¤´å®šä½åˆ°ç›®æ ‡ä½ç½®

æ—‹è½¬å»¶è¿Ÿï¼šç­‰å¾…ç›®æ ‡æ•°æ®å—æ—‹è½¬åˆ°ç£å¤´ä¸‹

ä¼ è¾“æ—¶é—´ï¼šå°†æ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…å­˜

ä¸»è¦çš„IOæ—¶é—´æ¶ˆè€—åœ¨æŸ¥æ‰¾å’Œæ—‹è½¬å»¶è¿Ÿä¸Š



> é¢„æµ‹è¡Œä¸º

ç¼“å­˜è®¿é—®æ¬¡æ•°å¤šçš„æ•°æ®å—

æå‰å°†å¾ˆæœ‰å¯èƒ½è¢«è®¿é—®çš„æ•°æ®æå–åˆ°å†…å­˜ä¸­

è‹¥è¦å†™å…¥çš„æ˜¯è¿ç»­çš„æ•°æ®å—ï¼Œåˆ™å¯ä»¥å…ˆè¿›è¡Œç¼“å­˜ï¼Œæœ€åä¸€å¹¶å†™å…¥ã€‚



> ç£ç›˜ä¸­æ•°æ®å—çš„ç»„ç»‡

Next block conceptï¼š

- åœ¨åŒä¸€ç£é“ä¸Šè¿ç»­çš„æ•°æ®å—
- åœ¨åŒä¸€ç£ç›˜ä¸Šçš„æ•°æ®å—
- åœ¨ç›¸é‚»ç£ç›˜ä¸Šçš„æ•°æ®å—

å› æ­¤å¯ä»¥å°†æ–‡ä»¶çš„æ•°æ®å—åœ¨ç£ç›˜ä¸Šè¿ç»­å­˜å‚¨ï¼Œæ¥ä»‹ç»æŸ¥è¯¢å’Œæ—‹è½¬å»¶è¿Ÿ

å¯¹äºé¡ºåºçš„æ‰«æï¼Œå°±å¯ä»¥åšåˆ°æå‰æå–ï¼Œä¸€æ¬¡è¯»å–å¤§é‡è¿ç»­çš„æ•°æ®å—ï¼ˆä¸€æ¬¡æ€§å°†æ–‡ä»¶çš„å¤§éƒ¨åˆ†æå–åˆ°å†…å­˜ä¸­ï¼‰



### Files

è¡¨ä¼šè¢«å­˜å‚¨ä¸ºé€»è¾‘æ–‡ä»¶ï¼Œç”±æ•°æ®å—æ„æˆï¼Œæ¯ä¸ªæ•°æ®å—ä¸­éƒ½å­˜å‚¨ä¸€ç³»åˆ—è®°å½•



>  DB File Structures

1. Unordered Heap Files

   è®°å½•åœ¨é¡µä¸­éšæ„å­˜æ”¾ï¼Œé€‚ç”¨äºç»å¸¸æŸ¥è¯¢æ‰€æœ‰è®°å½•çš„æƒ…å†µ

2. Clustered Heap Files

   è®°å½•å’Œé¡µè¢«åˆ†ç»„å­˜æ”¾

3. Sorted Files

   è®°å½•å’Œé¡µæŒ‰æŸä¸€é¡ºåºå­˜æ”¾

4. Index Files

   å¯èƒ½ä¼šåŒ…å«æŒ‡å‘å…¶ä»–æ–‡ä»¶ä¸­è®°å½•çš„ç´¢å¼•



### Page

Headerä¼šåŒ…å«ï¼š

1. è®°å½•æ•°é‡
2. ç©ºä½™çš„ç©ºé—´
3. å¯èƒ½ä¼šæœ‰æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆ
4. å¯èƒ½ä¼šæœ‰Bitmaps



> å¸ƒå±€

æ–¹å‘ï¼š

- è®°å½•æ•°é‡ï¼ˆå®šé•¿è¿˜æ˜¯å˜é•¿ï¼‰

- æ˜¯å¦æ‰“åŒ…

  

å®šé•¿ï¼š

1. æ‰“åŒ…

   è®©è®°å½•ç¨ å¯†åˆ†å¸ƒï¼Œç±»ä¼¼é“¾è¡¨çš„å½¢å¼ã€‚

   Record id = (pageId, record number in page)

   æ·»åŠ å…ƒç´ ååˆ†å®¹æ˜“ï¼Œä½†åˆ é™¤éœ€è¦é‡ç»„æ•°æ®ï¼Œè®©åé¢çš„æ•°æ®å¡«è¡¥è¢«åˆ æ•°æ®çš„ç©ºç™½ã€‚

![image-20220528161445934](D:\develop\git\MyRemake\database\img\image-20220528161445934.png)

2. ä¸æ‰“åŒ…

   åœ¨å¤´éƒ¨æ·»åŠ bitmapsï¼Œæ ‡è®°æ¯ä¸ªå­˜å‚¨å•å…ƒçš„å­˜å‚¨æƒ…å†µ

   åœ¨æ’å…¥æ—¶åªè¦å¯»æ‰¾é¦–ä¸ªè¿˜æ²¡è¢«æ ‡è®°çš„å­˜å‚¨å•å…ƒå³å¯

   åˆ é™¤æ—¶åªéœ€è¦æ¸…é™¤bitmapsä¸­å¯¹åº”çš„ä½å³å¯

![image-20220528161648072](D:\develop\git\MyRemake\database\img\image-20220528161648072.png)



å˜é•¿ï¼š

åœ¨pageçš„åº•éƒ¨ç»´æŠ¤ä¸€ä¸ªslot directoryï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆä»å³å¾€å·¦ï¼‰ä¸ºè®°å½•çš„ä¸ªæ•°ï¼Œç¬¬äºŒä¸ªä¸ºæŒ‡å‘é¦–ä¸ªç©ºåœ°å€çš„æŒ‡é’ˆï¼Œå…¶ä½™ä½ç½®æ”¾ç½®å„ä¸ªè®°å½•çš„idã€‚

æ’å…¥å…ƒç´ æ—¶ï¼Œåªéœ€è¦ç›´æ¥æ’å…¥ç¬¬äºŒä¸ªæŒ‡é’ˆæŒ‡å‘çš„å­˜å‚¨å•å…ƒï¼Œå¹¶ç”¨ä¸€ä¸ªé—²ç½®æ§½è®°å½•æ–°çºªå½•çš„idå³å¯

åˆ é™¤å…ƒç´ æ—¶ï¼Œå›æ”¶å¯¹åº”çš„å­˜å‚¨å•å…ƒï¼Œå¹¶æ¸…é™¤å¯¹åº”idæ‰€åœ¨çš„æ§½ã€‚

åˆ é™¤ä¼šå¯¼è‡´pageä¸­å‡ºç°ä¸è¿ç»­çš„ç©ºé—²ç©ºé—´ï¼Œæ­¤æ—¶å¯ä»¥å¯¹å…¶è¿›è¡Œå†åˆ†é…ï¼Œä¹Ÿå¯ä»¥ç­‰å‰©ä½™è¿ç»­ç©ºé—´ç”¨å®Œåå†æ¸…ç†ã€‚

è€Œå½“pageå¤§å°éœ€è¦å˜åŒ–æ—¶ï¼Œä¾‹å¦‚pageéœ€è¦æ‰©å®¹ï¼Œåˆ™ç›´æ¥åœ¨slot directoryçš„æœ€åæ·»åŠ è®°å½•idå³å¯ï¼ˆä»å³å¾€å·¦çœ‹ï¼‰

![image-20220528163256111](D:\develop\git\MyRemake\database\img\image-20220528163256111.png)



### Record

å…³ç³»æ¨¡å‹

æ¯æ¡è®°å½•éƒ½æœ‰ä¸€äº›å›ºå®šçš„ç±»å‹

ä¸å°†ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨è®°å½•ä¸­è€Œæ˜¯æ”¾åœ¨ç³»ç»Ÿç›®å½•ä¸­ï¼Œä»¥æ­¤èŠ‚çœç©ºé—´ï¼Œ



> å®šé•¿

åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ‰€æœ‰è®°å½•ä¸­å­—æ®µçš„ç±»å‹éƒ½æ˜¯ä¸€è‡´çš„

åœ¨å†…å­˜å’Œç£ç›˜ä¸­å­—èŠ‚çš„è¡¨ç°å½¢å¼ä¸€è‡´ã€‚



> å˜é•¿

å°†å˜é•¿çš„å­—æ®µæ”¾åœ¨å°¾éƒ¨ï¼Œæ·»åŠ ä¸€ä¸ªè®°å½•å¤´ï¼Œå…¶ä¸­å­˜å‚¨æŒ‡å‘å˜é•¿å­—æ®µçš„æŒ‡é’ˆä»¥åŠé•¿åº¦

![image-20220530094616356](D:\develop\git\MyRemake\database\img\image-20220530094616356.png)



### Index

ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œåˆ©ç”¨search keyå®ç°å¯¹data entryçš„å¿«é€ŸæŸ¥æ‰¾å’Œä¿®æ”¹

æŸ¥æ‰¾æ“ä½œéœ€è¦æ”¯æŒè®¸å¤šç±»å‹çš„æ“ä½œï¼Œä¾‹å¦‚æ¯”è¾ƒæ—¶éœ€è¦è€ƒè™‘ä¸€ç»´è¿˜æ˜¯äºŒç»´æ¯”è¾ƒ

search keyå¯ä»¥æ˜¯è¡¨å­—æ®µçš„ä»»æ„å­é›†ï¼Œå¹¶ä¸”ä¸ä¸€å®šè¦æ˜¯uniqueé”®ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸå…·æœ‰å”¯ä¸€æ€§çš„å¤åˆå±æ€§

data entry:å­˜å‚¨åœ¨ç´¢å¼•ä¸­çš„æ¡ç›®



#### ISAM

æœ€ç®€å•çš„åšæ³•ï¼šå¯¹å­˜å‚¨é”®å€¼çš„æ–‡ä»¶ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ã€‚ä½†å› ä¸ºæœ‰è·¨é¡µä¸­æ–­ï¼Œå› æ­¤æ•ˆç‡ä¸€èˆ¬

æ”¹è¿›ï¼šå†å¤šåŠ ä¸€å±‚è¿æ¥ä¸åŒçš„pageï¼Œå°†å…¶ä½œä¸ºæŸ¥æ‰¾æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚èŠ‚ç‚¹æœ¬èº«çš„é”®å€¼èµ·åˆ°æ ‡è¯†å·¦å³å­æ ‘èŒƒå›´çš„ä½œç”¨ã€‚

![image-20220530150809929](D:\develop\git\MyRemake\database\img\image-20220530150809929.png)

å‹ç¼©ï¼šæ¯ä¸ªå†…éƒ¨èŠ‚ç‚¹çš„æœ€å·¦è¾¹çš„å€¼å¯ä»¥è¢«çœç•¥ã€‚

æ’å…¥ï¼šåœ¨æŒ‡å®šä½ç½®æ’å…¥å¯¹åº”èŠ‚ç‚¹ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ’åºã€‚å¦‚æœæ’å…¥åä¼šè¶…å‡ºåŸå…ˆèƒ½å®¹çº³çš„æ•°æ®é‡ï¼Œåˆ™ä¼šå†å¼€è¾Ÿä¸€å—Overflow pageså­˜å‚¨ï¼Œè¢«é€»è¾‘è¿æ¥åˆ°æœ€åä¸€å—é¡µæ•°æ®ä¹‹åã€‚éšç€è¶…å‡ºæ•°æ®é‡çš„å¢å¤šï¼ŒæŸ¥æ‰¾é€Ÿåº¦ä¼šé€æ­¥é€€åŒ–æˆçº¿æ€§ã€‚



#### B+ Tree

ç»“æ„ä¸ISAMç±»ä¼¼, èŠ‚ç‚¹å­˜å‚¨<Key, Page Ptr>

ä½†B+æ ‘å¯ä»¥å®ç°åŠ¨æ€ç´¢å¼•ï¼Œä¿æŒæ ‘æ°¸è¿œæ˜¯å¹³è¡¡çš„ï¼Œå¹¶ä¸”æ”¯æŒæ›´é«˜æ•ˆçš„æ’å…¥å’Œåˆ é™¤ï¼Œå› ä¸ºå¢é•¿éƒ½ä½“ç°åœ¨æ ¹èŠ‚ç‚¹è€Œéå¶å­èŠ‚ç‚¹ã€‚

çº¦æŸæ¡ä»¶ï¼š

1. æ¯ä¸€ä¸ª**å†…éƒ¨ç»“ç‚¹**è‡³å°‘è¢«å¡«æ»¡ä¸€åŠï¼Œd <= #entry <= 2d
2. dç§°ä¸ºBæ ‘çš„é˜¶æ•°ï¼Œç»“ç‚¹æœ€å¤§æ‰‡å‡ºæ•°ä¸º2d+1

B+æ ‘çš„å¶å­ç»“ç‚¹ä¹‹é—´å¿…é¡»åšé€»è¾‘è¿æ¥ï¼Œå› ä¸ºä»–ä¸åƒISAMä¸€æ ·åœ¨ç‰©ç†å±‚é¢å°±è¿åœ¨ä¸€èµ·ï¼Œä½†è¿™ä¹Ÿæ–¹ä¾¿å®ƒè¿›è¡ŒåŠ¨æ€åˆ†é…ã€‚

![image-20220531192910950](D:\develop\git\MyRemake\database\img\image-20220531192910950.png)

æ’å…¥æ“ä½œï¼š

æŸ¥æ‰¾åˆ°æ–°æ•°æ®åº”åœ¨çš„å¶å­ç»“ç‚¹

1. è‹¥è¯¥ç»“ç‚¹æœªæ»¡ï¼šç›´æ¥å°†å…¶å­˜å…¥ï¼Œå¹¶é‡æ–°æ’åº

2. è‹¥è¯¥ç»“ç‚¹å·²æ»¡ï¼šåˆ†è£‚å½“å‰ç»“ç‚¹ï¼Œå»ºç«‹ä¸€ä¸ªæ–°çš„ç»“ç‚¹ï¼Œå°†ç°æœ‰çš„2d+1ä¸ªæ•°æ®ä¸­è¾ƒå°çš„dä¸ªæ‹·è´è¿›ä¸€ä¸ªç»“ç‚¹1ï¼Œå¦ä¸€éƒ¨åˆ†æ‹·è´è¿›å¦ä¸€ä¸ªç»“ç‚¹2ã€‚ç„¶åå°†ç»“ç‚¹2ä¸­æœ€å°çš„æ•°æ®æ‹·è´ä¸€ä»½ä¼ å…¥çˆ¶èŠ‚ç‚¹ä¸­ã€‚è‹¥çˆ¶èŠ‚ç‚¹å·²æ»¡é‡å¤ä¸Šè¿°æ­¥éª¤ã€‚

   å¦‚æœè¦å‘æ–°çš„ç´¢å¼•ç»“ç‚¹ä¼ é€’æ•°æ®ï¼Œåˆ™ç›´æ¥æ¨å…¥ï¼Œè€Œéæ‹·è´ã€‚

   reï¼šå¯¹äºB+æ ‘æ¥è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å­˜åœ¨å¶å­ç»“ç‚¹ï¼Œå› æ­¤å¿…é¡»åœ¨å¶å­ç»“ç‚¹ä¿ç•™ç›¸å…³æ•°æ®ï¼Œè€Œå…¶å¯¹åº”çš„å€¼åˆ™å¯ä»¥ä¼ åˆ°ç´¢å¼•ç»“ç‚¹èµ·åˆ°åˆ’åˆ†åŸŸçš„ä½œç”¨ã€‚

å¤§è§„æ¨¡æ’å…¥æ“ä½œï¼š

å°†è¦æ’å…¥çš„æ•°æ®æŒ‰ç…§é”®å…ˆè¿›è¡Œæ’åºï¼Œç„¶åç›´æ¥å‘å¶å­ç»“ç‚¹æ’å…¥æ•°æ®ï¼Œè¶…å‡ºå¯å®¹çº³ä¸ªæ•°æ—¶å°±è¿›è¡Œåˆ†è£‚ï¼Œç¡®ä¿æ¯ä¸€ä¸ªå¶å­ç»“ç‚¹ä¸­çš„æ•°æ®é‡éƒ½è¾¾åˆ°æ’å…¥å› å­ã€‚è¿™æ ·å’Œåå¤çš„æ’å…¥ç›¸æ¯”èŠ‚çœäº†å¤§é‡IOæ—¶é—´ï¼Œå·²ç»å®Œæˆè£…è½½çš„éƒ¨åˆ†ä¸ä¼šè¢«ç®—æ³•è€ƒè™‘ï¼ŒèŠ‚çœæ—¶é—´ã€‚



ç´¢å¼•ç»“æ„éœ€è¦è€ƒè™‘çš„é—®é¢˜

1. æ”¯æŒçš„æŸ¥è¯¢
2. Search keyçš„é€‰æ‹©
3. æ•°æ®çš„å­˜å‚¨æ–¹å¼
4. å˜é•¿é”®çš„å¤„ç†
5. æ€§èƒ½æ¶ˆè€—



#### Search Key and Ordering

åœ¨ä¸€ä¸ªæœ‰åºçš„ç´¢å¼•ä¸­ï¼Œå®ƒçš„é”®éƒ½ä¼šæŒ‰ç…§å­—å…¸åºæ’åˆ—

å­—å…¸åºï¼šå…ˆæ¯”è¾ƒsearch keyä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œè‹¥ç›¸ç­‰ï¼Œç»§ç»­æ¯”è¾ƒç¬¬äºŒä¸ªå­—æ®µï¼Œä»¥æ­¤ç±»æ¨ã€‚

ä¸€ä¸ªå¤åˆæŸ¥è¯¢é”®çš„æ ¼å¼ï¼šæ•´ä¸ªæŸ¥è¯¢ç”±mä¸ªç­‰å€¼æ¯”è¾ƒä¸ä¸€ä¸ªå¤§å°æ¯”è¾ƒ(å¿…é¡»æ”¾åœ¨æœ€å)æ„æˆã€‚å“¦



#### Data Entry Storage

æ•°æ®åœ¨ç´¢å¼•ä¸­çš„å­˜å‚¨æ–¹å¼ï¼š

1. å€¼
2. å•ä¸€å¼•ç”¨
3. å¼•ç”¨é“¾è¡¨ï¼ˆå½“æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œå•ä¸€å¼•ç”¨çš„å­˜å‚¨æ–¹å¼ä¼šåˆ†è£‚å‡ºå¤§é‡çš„ç´¢å¼•è®°å½•ï¼‰

å¦‚æœå­˜å‚¨å¼•ç”¨ï¼Œåˆ™å¿…é¡»èƒ½æ”¯æŒå¤šç´¢å¼•æŸ¥è¯¢ï¼Œå¦åˆ™å°±éœ€è¦ä¸ºæ¯ä¸ªç´¢å¼•éƒ½å»ºç«‹ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œå¯¼è‡´æ•°æ®å†—ä½™ï¼ŒåŠ å¤§ä¿®æ”¹æ•°æ®çš„éš¾åº¦ã€‚



Clustered vs. Unclustered Index

èšåˆç´¢å¼•ä¼šæ ¹æ®search keyç¡®ä¿ç´¢å¼•*å¤§è‡´æœ‰åº*(å¹¶ä¸è¦æ±‚ç»å¯¹é¡ºåº)

å› æ­¤èšåˆç´¢å¼•å¾€å¾€èƒ½æä¾›æ¯”è¾ƒå¥½çš„æŸ¥è¯¢æ€§èƒ½ã€‚åŒæ—¶é¡ºåºçš„ç£ç›˜è®¿é—®ä¹Ÿæœ‰åŠ©äºè¿›è¡Œç±»ä¼¼prefetchingä¹‹ç±»çš„ä¼˜åŒ–å·¥ä½œï¼Œå¹¶ä¸”ä¹Ÿæ–¹ä¾¿è¿›è¡Œå‹ç¼©æ“ä½œã€‚

![image-20220602203353495](D:\develop\git\MyRemake\database\img\image-20220602203353495.png)

å¯¹äºèšåˆç´¢å¼•ï¼Œå®ƒåœ¨æŸ¥è¯¢æ—¶è¦æ¶‰åŠçš„é¡µæ˜æ˜¾å°‘äºéèšåˆç´¢å¼•ã€‚

ä½†èšåˆç´¢å¼•çš„ç»´æŠ¤æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œå¹¶ä¸”ç”±äºå…¶åœ¨åˆå§‹æ’å…¥æ—¶ä¼šé¢„ç•™1/3ç©ºé—´ç»™ä¹‹åçš„æ’å…¥æ“ä½œï¼Œä¼šå¸¦æ¥ä¸€å®šçš„ç©ºé—´æµªè´¹ã€‚



Variable Length Keys & Records

å½“å­—æ®µä¸ºå˜é•¿æ—¶ï¼Œé¡ºåºå°±å¤±å»äº†æ„ä¹‰ï¼ˆéš¾ä»¥æ¯”è¾ƒï¼‰ï¼Œä¸åŒçš„ç»“ç‚¹ä¼šå­˜å‚¨ä¸åŒé•¿åº¦çš„æ¡ç›®ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¸åŒç´¢å¼•å­˜å‚¨çš„è®°å½•å¼•ç”¨ä¸ªæ•°ä¹Ÿä¼šäº§ç”Ÿè¾ƒå¤§çš„å·®è·ï¼Œä¸åˆ©äºé«˜æ•ˆæŸ¥è¯¢ã€‚

å› æ­¤é’ˆå¯¹å˜é•¿çš„å­—æ®µï¼Œæˆ‘ä»¬åœ¨è¦æ±‚å¡«å……è¶…è¿‡åŠæ•°æ—¶ï¼Œæ˜¯ä»å­—èŠ‚æ•°çš„è§’åº¦è¿›è¡Œè¡¡é‡ã€‚

é”®åç¼€å‹ç¼©

æå–è®°å½•ä¸­é”®çš„æœ€å°å‰ç¼€æ”¾åœ¨å¤´éƒ¨ï¼Œç„¶åå°†å‰©ä½™éƒ¨åˆ†é“¾æ¥ä¸Šå»ã€‚

![image-20220602205107634](D:\develop\git\MyRemake\database\img\image-20220602205107634.png)

é€‚ç”¨äºå¤åˆé”®ï¼Œä¸”é¦–ä¸ªå±æ€§ä¸ªä½“å·®å¼‚ä¸å¤§ï¼Œä¹‹åçš„å±æ€§å·®å¼‚è¾ƒå¤§ã€‚



## Buffer Management

![image-20220608222913582](D:\develop\git\MyRemake\database\img\image-20220608222913582.png)

å½“ä¸Šå±‚å‘ç¼“å­˜å‘èµ·è¯·æ±‚æ—¶ï¼Œç¼“å­˜ä¼šå…ˆåœ¨å†…éƒ¨æŸ¥æ‰¾æœ‰æ²¡æœ‰éœ€è¦çš„æ•°æ®é¡µï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»ç£ç›˜è¯»å–åˆ°ç¼“å­˜ï¼Œç„¶åè¿”å›ã€‚

è„é¡µï¼šåœ¨ç¼“å­˜ä¸­æœ‰æ•°æ®è¢«ä¿®æ”¹ï¼Œä½†è¿˜æ²¡æœ‰åˆ·å…¥å†…å­˜çš„æ•°æ®é¡µ

å¤„ç†æ–¹å¼ï¼šç”¨ä¸€ä¸ªdirty bitæ ‡è¯†å½“å‰é¡µæ˜¯å¦æ˜¯è„é¡µã€‚

| FrameId | PageId | Dirty? | Pin count |
| ------- | ------ | ------ | --------- |
| 1       |        |        |           |
| 2       |        |        |           |
| 3       |        |        |           |

Pin countæ˜¾ç¤ºå½“å‰æœ‰å¤šå°‘ä»»åŠ¡åœ¨ä½¿ç”¨è¯¥ç¼“å­˜



### Replacement Policy

æ›¿æ¢ç­–ç•¥ï¼š

Least-recently-used(LRU), Clock

Most-recently-used(MRU)

æ ¹æ®è®¿é—®çš„æ•°æ®ç‰¹å¾é€‰æ‹©



#### LRU

æ›¿æ¢åŸåˆ™ï¼šæŒ‘é€‰å½“å‰ä¸è¢«ä½¿ç”¨çš„ï¼Œä¸”åœ¨è¿‘æœŸéƒ½æ²¡æœ‰è¢«ä½¿ç”¨çš„æ•°æ®é¡µæ›¿æ¢

æ–¹æ³•ï¼šåœ¨ç¼“å­˜æ± çš„ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ªè®°å½•ä¸Šä¸€æ¬¡ä½¿ç”¨æˆªæ­¢æœŸçš„å­—æ®µ

| FrameId | PageId | Dirty? | Pin count | Last used |
| ------- | ------ | ------ | --------- | --------- |
| 1       |        |        |           |           |
| 2       |        |        |           |           |
| 3       |        |        |           |           |

ä¼˜åŠ¿ï¼šå¯¹äºéƒ¨åˆ†æ•°æ®éœ€è¦è¢«é¢‘ç¹è®¿é—®çš„æƒ…å†µå¾ˆå‹å¥½

åŠ£åŠ¿ï¼šæ‰¾åˆ°æœ€ä¸å—å¾…è§çš„æ•°æ®é¡µéœ€è¦çº¿æ€§æ—¶é—´ï¼ˆå¯ä»¥ç”¨å †ä¼˜åŒ–åˆ°å¯¹æ•°çº§ï¼‰



#### Clock

ä¸€ç§ç±»LRUç­–ç•¥ï¼Œç”¨ä¸€ä¸ªæŒ‡é’ˆä¾æ¬¡æ‰«æç¼“å­˜æ± ä¸­çš„Frameï¼Œåœ¨ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ªå­—æ®µè¡¨ç¤ºæ˜¯å¦ä¸ºæœ€è¿‘è®¿é—®çš„å­—æ®µã€‚

![image-20220608224724744](D:\develop\git\MyRemake\database\img\image-20220608224724744.png)

è‹¥æŒ‡å‘çš„é¡µæ­£åœ¨è¢«ä½¿ç”¨ï¼Œç›´æ¥è·³è¿‡ã€‚è‹¥æŒ‡å‘çš„é¡µref bitsä¸º1ï¼Œä¸”æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œåˆ™å°†ref bitsç½®ä¸º0ã€‚è‹¥æŸé¡µæ—¢æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œref bitsä¹Ÿä¸º0ï¼Œåˆ™å°†å®ƒæ›¿æ¢ä¸‹æ¥ã€‚



Clockæ›¿æ¢æ‰çš„ä»…ä»…æ˜¯å½“å‰ä¸çƒ­é—¨çš„æ•°æ®ï¼Œè€ŒLRUä¼šæ›¿æ¢æ‰æœ€ä¸çƒ­é—¨çš„æ•°æ®ï¼Œå› æ­¤Clockç›¸å¯¹æ¥è¯´å¼€é”€ä¼šå°ä¸€ç‚¹ã€‚



ä½†LRUç±»å‹çš„ç­–ç•¥åœ¨é¢å¯¹å¤§å‹æ•°æ®æ—¶éƒ½å­˜åœ¨è‡´å‘½ç¼ºé™·:

å½“æ•°æ®é¡µçš„æ•°é‡è¶…è¿‡äº†ç¼“å­˜æ± çš„å¤§å°æ—¶ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¼šç›´æ¥é™ä¸º0ã€‚è€ƒè™‘æ–‡ä»¶é•¿åº¦ä¸º7é¡µï¼Œç¼“å­˜æ± å¤§å°ä¸º6é¡µï¼Œè¯»å–å‰6é¡µæ—¶éƒ½åœ¨å¡«å……ç¼“å­˜æ± ï¼Œå½“è¯»å–åˆ°ç¬¬7é¡µæ—¶ï¼Œä¼šå°†ç¬¬1é¡µè¸¢æ‰ã€‚è‹¥ä¸‹ä¸€æ­¥æ˜¯å†æ¬¡è¯»å–ç¬¬1é¡µï¼Œåˆ™åˆéœ€è¦è®²ç¬¬1é¡µé‡æ–°ä»ç£ç›˜è¯»å…¥ç¼“å­˜ã€‚LRUä¼šå°†åç»­é©¬ä¸Šè¦ç”¨åˆ°çš„æ•°æ®è¸¢å‡ºç¼“å­˜ï¼Œå¤§å¤§é™ä½äº†æ•ˆç‡ã€‚



#### MRU

å½“MRUå¤„ç†å¤§å‹æ–‡ä»¶æ—¶ï¼Œç¬¬ä¸€è½®ä¸LRUæ— å¼‚ã€‚ä½†åœ¨å¤„ç†ç¬¬7é¡µæ•°æ®æ—¶ï¼Œå®ƒä¼šè¸¢æ‰æœ€è¿‘ä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬6é¡µã€‚ä¹‹åå†æ¬¡è¯»å–ç¬¬1é¡µæ—¶å°±ä¼šå‘½ä¸­ç¼“å­˜ï¼Œå¹³å‡æ¯æ¬¡è¯»å–ç¼“å­˜å‘½ä¸­æ¬¡æ•°ä¸ºB - (N-B)ã€‚å› æ­¤å½“æ–‡ä»¶è¿‡å¤§æ—¶ï¼Œå‘½ä¸­æ¬¡æ•°ä¹Ÿä¼šä¸‹é™ã€‚



ç»¼ä¸Šï¼šLRUåœ¨éšæœºè¯»å–ï¼Œæ¶‰åŠçƒ­é—¨ç¨‹åº¦çš„æ•°æ®çš„è¯»å–ä¸Šå æ®ä¼˜åŠ¿ã€‚MRUåœ¨é‡å¤è¯»å–ä¸Šå æ®ä¼˜åŠ¿ã€‚DBMSä¼šæ ¹æ®æŸ¥è¯¢æ•°æ®ç‰¹å¾é€‰æ‹©ç›¸å¯¹ä¼˜ç§€çš„ç­–ç•¥ã€‚



### DBMS vs OS Buffer Cache

OSä¸ä¼šç®¡ç†æ•°æ®åº“çš„ç¼“å­˜

reï¼š

1. ä¸åŒOSæ”¯æŒçš„æ“ä½œä¸ç›¸åŒï¼Œä½†éƒ½ä¼šæ”¯æŒDBMSï¼Œå› æ­¤æ”¾åœ¨DBMSä¸Šå…·å¤‡æ›´å¥½çš„é€‚é…æ€§
2. OSåªèƒ½è¯†åˆ«ç‰©ç†å±‚é¢ä¸Šçš„è¿ç»­çš„æ•°æ®é¡µï¼Œè€ŒDBMSå¯ä»¥æ ¹æ®å…¶ç´¢å¼•ï¼Œä¾‹å¦‚B+æ ‘å¶å­ç»“ç‚¹çš„å…„å¼Ÿå±æ€§æ¥è¯†åˆ«é€»è¾‘ä¸Šè¿ç»­çš„æ•°æ®é¡µï¼Œèƒ½å¤Ÿæ›´å¥½çš„è¿›è¡Œç±»ä¼¼pre-fetchingçš„æ“ä½œã€‚
3. OSæ— æ³•å¼ºåˆ¶è®©æ•°æ®åˆ·å…¥ç£ç›˜ã€‚



## Sorting and Hashing



### out-of-core algorithm



#### Single passing Streaming

åˆ©ç”¨å‡½æ•°f(x)å°†è®°å½•æ˜ å°„ä¸ºå¦ä¸€ä¸ªå€¼ã€‚

å°½å¯èƒ½åœ°å‡å°‘RAMçš„ä½¿ç”¨ï¼ˆæ˜ å°„å‡½æ•°éœ€è¦è®©äº§å‡ºçš„ç»“æœå ç”¨ç©ºé—´å°äºå…¶å¯¹åº”çš„è®°å½•ï¼‰ï¼Œé™ä½IOä½¿ç”¨ç‡ã€‚

![image-20220611220459995](D:\develop\git\MyRemake\database\img\image-20220611220459995.png)

#### Double Buffer

ä¸»çº¿ç¨‹åˆ©ç”¨ä¸€å¯¹è¾“å…¥è¾“å‡ºç¼“å†²åŒºè¿›è¡Œå¸¸è§„çš„æ˜ å°„æ“ä½œã€‚

å¦åŠ ä¸€ä¸ªIOçº¿ç¨‹ï¼Œå‘ç›®å‰æ²¡æœ‰ä½¿ç”¨çš„è¾“å…¥è¾“å‡ºç¼“å†²åŒºå¡«å……/é‡Šæ”¾æ•°æ®ã€‚

å½“ä¸»çº¿ç¨‹å®Œæˆæ“ä½œï¼Œç­‰å¾…ç¼“å†²åŒºæ—¶ï¼Œç›´æ¥äº¤æ¢ç¼“å†²åŒºã€‚

![image-20220611220755064](D:\develop\git\MyRemake\database\img\image-20220611220755064.png)

![image-20220611220804636](D:\develop\git\MyRemake\database\img\image-20220611220804636.png)



#### 2-Way

Pass 0ï¼š

è¯»å–ä¸€ä¸ªæ•°æ®é¡µï¼Œæ’åºå¹¶å†™å…¥ã€‚

åªä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºã€‚

é‡å¤ç±»ä¼¼æ­¥éª¤ï¼Œå°†æ•´ä¸ªæ–‡ä»¶åŒ…å«çš„æ•°æ®é¡µå†™å…¥ï¼Œå¹¶ä¿è¯æ¯ä¸€é¡µæœ‰åºã€‚

Pass 1ï¼Œ2ï¼Œ3 ...:

è‡³å°‘éœ€è¦3ä¸ªç¼“å†²åŒºï¼ˆå‡è®¾æ¯ä¸ªç¼“å†²åŒºçš„å¤§å°ä¸ºä¸€ä¸ªæ•°æ®é¡µï¼‰

å°†ä¸¤ä¸ªè¾“å…¥ç¼“å†²åŒºçš„æ•°æ®è¿›è¡Œå½’å¹¶æ’åºä¼ ç»™è¾“å‡ºç¼“å†²åŒºã€‚



> 2-Way External sort

æ‹¥æœ‰>3ä¸ªç¼“å†²åŒº

Pass 0:

ä½¿ç”¨Bä¸ªç¼“å†²åŒºï¼Œæ¯æ¬¡å¯¼å…¥Bé¡µæ•°æ®ï¼Œæ€»å…±éœ€è¦N/Bï¼ˆä¸Šå–ï¼‰ä¸ªrunsï¼Œæ¯ä¸€ä¸ªrunsé‡Œè¿è¡Œä¸€ä¸ªæ’åºè¿›ç¨‹ã€‚

Pass 1ï¼š

æ¯ä¸ªrunsçš„æ•°æ®é•¿åº¦ä¸ºBï¼Œæœ¬è½®å¯ä»¥è¿›è¡ŒB-1ä¸ªrunsçš„å½’å¹¶

![image-20220611224041793](D:\develop\git\MyRemake\database\img\image-20220611224041793.png)

å› æ­¤åœ¨Pass 1å¯ä»¥å®ŒæˆB(B-1) pagesæ•°æ®çš„æ’åºã€‚



#### Hash

å°†æ•°æ®åˆ†æ‰¹è¯»å–åˆ°å†…å­˜ä¸­ï¼Œåœ¨è¿›è¡Œhashæ“ä½œã€‚

ä¸¤æ­¥éª¤ï¼š

1. Divide

   ä½¿ç”¨å“ˆå¸Œå‡½æ•°hpå°†è®°å½•æµä¼ é€’åˆ°æŒ‡å®šçš„ç£ç›˜åˆ†åŒºï¼Œå…ˆå°†ç‰¹å¾ç›¸è¿‘çš„æ•°æ®åˆ†é…åˆ°åŒä¸€åˆ†åŒºï¼Œå°†åºå¤§çš„æ•°æ®æ‹†åˆ†æˆå¯è¢«å†…å­˜å¤„ç†çš„æ•°æ®å—ã€‚ï¼ˆåˆ†æ²»æ³•ä¸­çš„åˆ’åˆ†å­é—®é¢˜ï¼‰

   æ»¡è¶³åŒ¹é…æ¡ä»¶çš„éƒ½å¤„åœ¨åŒä¸€åˆ†åŒºï¼Œç¡®ä¿å…·æœ‰åŒæ ·ç‰¹å¾çš„å€¼ä¸ä¼šåœ¨å†…å­˜ä¸­è¢«ä¸åŒçš„å“ˆå¸Œè¡¨è®¡ç®—ï¼ˆå»é™¤å†—ä½™ï¼‰ã€‚

   ![image-20220611230629236](D:\develop\git\MyRemake\database\img\image-20220611230629236.png)

2. Conquer

   åˆ©ç”¨å“ˆå¸Œå‡½æ•°hrï¼Œå°†åˆ†åŒºè¯»å–åˆ°RAMçš„hashè¡¨ä¸­

   ç„¶åè¯»å–æ¡¶ä¸­çš„æ•°æ®ï¼Œå¹¶å°†å®ƒä»¬å›å†™åˆ°ç£ç›˜ä¸­
   
   å°†å·²ç»è¢«åˆ†åŒºçš„æ•°æ®å—è¿›è¡Œå“ˆå¸Œæ˜ å°„ã€‚ï¼ˆåˆ†æ²»æ³•ä¸­çš„è§£å†³å­é—®é¢˜ï¼‰

![image-20220611230641780](D:\develop\git\MyRemake\database\img\image-20220611230641780.png)

è‹¥åˆ’åˆ†ä¹‹åçš„æ•°æ®å—è¿˜æ˜¯å¾ˆå¤§ï¼Œåˆ™è¿›è¡Œé€’å½’åˆ’åˆ†æ“ä½œï¼Œæ»¡è¶³æ¡ä»¶åå†è¿›è¡ŒConquerã€‚ï¼ˆåˆ†æ²»æ³•ä¸­çš„é€’å½’åˆ’åˆ†é—®é¢˜ï¼‰



## Iterator



### å…³ç³»æ“ä½œç¬¦å’ŒæŸ¥è¯¢è§„åˆ’

å‡è®¾æœ‰ä¸€æŸ¥è¯¢
$$
ğœ‹_{sname}(ğœ‹_{sid}(ğœ‹_{bid}(ğœ_{color}='red'(Boats)) â‹ˆ Res) â‹ˆ Sailors)
$$
åˆ™å…¶å¯¹åº”çš„æ•°æ®æµå›¾ä¸º

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220630213659.png)

å…¶ä¸­æ¯ä¸€æ¡è¾¹éƒ½ä»£è¡¨æ•°æ®çš„æµå‘

ç»“ç‚¹ä»£è¡¨å…³ç³»è¿ç®—ç¬¦

æºä»£è¡¨æŸä¸ªå…³ç³»



### è¿­ä»£å™¨

å¯¹äºæ¯ä¸€ä¸ªå…³ç³»è¿ç®—ç¬¦è¦åšçš„æ“ä½œéƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„è¿­ä»£å™¨ã€‚ç­›é€‰ä¼ å…¥æ•°æ®æµä¸­ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œå†ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæ“ä½œçš„è¿­ä»£å™¨ä¸­ã€‚

```java
abstract class iterator {
    void setup(List<Iterator> inputs);
    void init(args);
    tuple next();
    void close();
}
```

initå’Œnextæ“ä½œå¯ä»¥é‡‡å–æµå¼æˆ–æ‰¹é‡ç®—æ³•

æµå¼ï¼šæ¯æ¬¡è°ƒç”¨åªæœ‰å°‘é‡ï¼Œæœ‰é™çš„å·¥ä½œã€‚

æ‰¹é‡ï¼šæ¯æ¬¡æ‰§è¡Œä¸€ç³»åˆ—çš„å·¥ä½œï¼Œåœ¨å®Œæˆä¹‹å‰ä¸ä¼šäº§ç”Ÿè¾“å‡ºã€‚



#### Select

```
init(predicate): 
    child.init()
    pred = predicate;
    current = NULL;
next(): 
    while (current != EOF && !pred(current))
        current = child.next();
    return current; 
close(): 
    child.close()

```

é¦–å…ˆåˆå§‹åŒ–è‡ªå·±çš„å­ç»“ç‚¹ï¼Œå¹¶è£…é…æ–­è¨€

next():ä¸æ–­å¾ªç¯ç›´è‡³åˆ°è¾¾æ–‡ä»¶æœ«å°¾æˆ–æ˜¯å½“å‰å­—æ®µæ»¡è¶³æ–­è¨€æ¡ä»¶



#### Heap Scan

è¯¥è¿­ä»£å™¨ä¸å¯èƒ½æœ‰å­©å­ï¼Œå› ä¸ºå…¶å¤„äºæœ€åº•å±‚ï¼Œè´Ÿè´£ä»ç£ç›˜ä¸­è¯»å–æŒ‡å®šå…³ç³»çš„æ•°æ®ã€‚

```
init(relation): 
    heap = open heap file for this relation;
    cur_page = heap.first_page(); // first page
    cur_slot = cur_page.first_slot(); // first slot on that page
    
next(): 
    if (cur_page == NULL) return EOF;  // End Of Fun
    current = [cur_page, cur_slot]; // we will return this recordId
    // advance the slot
    cur_slot = cur_slot.next();
    if (cur_slot == NULL) {
      // advance to next page, first slot
      cur_page = cur_page.next();
      if (cur_page != NULL)
         cur_slot = cur_page.first_slot();
    }
    return current; 
    
close(): 
	heap.close()
```



#### Sort

```
init(keys):                // all of pass 0 in init, a blocking call
    child.init()
    repeatedly call child.next() and generate the sorted runs on disk, until child gives EOF
    // set up for pass 1, assumes enough buffers to merge
    open each sorted run file and load into input buffer for pass 1
    
next():              // pass 1 (assumes enough buffers to merge)
    output = min tuple across all buffers
    if min tuple was last one in its buffer, fetch next page from that run into buffer
    return output (or EOF -- â€œEnd of Funâ€ -- if no tuples remain)
close(): 
    deallocate the runs files
    child.close()

```

é¦–å…ˆåˆå§‹åŒ–æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç¡®ä¿ä»–ä»¬ä»¥åŠå‡†å¤‡å¥½äº†ä¸‹ä¸€æ­¥æ“ä½œã€‚ç„¶åè·å–å­èŠ‚ç‚¹çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶ç…§ä¸Šä¸€ç« æ‰€è®²çš„æ’åºæ–¹æ³•è¿›è¡Œç¬¬0è½®æ’åºã€‚å®Œæˆåå°†æ‰€æœ‰çš„æ•°æ®è½½å…¥ç¼“å†²åŒºè¿›è¡Œå½’å¹¶ã€‚



#### Group By

```
init(group_keys, aggs):
    child.init()
    cur_group = NULL;
next():
    result = NULL
    do {
        tup = child.next();
        if (group(tup) != cur_group) { // New group!
            if (cur_group != NULL)     // Form a result for current group
                result = [cur_group, final() of all aggs]
            cur_group = group(tup);
            call init() on all the aggs
        } 	
        call merge(tup) on all the aggs 
    } while (!result);
    return result;
close():
	child.close()

```

è¿™ç§å®ç°æ–¹å¼çš„å‰ææ˜¯å·²ç»å®Œæˆæ’åºã€‚åˆå§‹åŒ–å‚æ•°æ˜¯è¦åˆ†ç»„çš„é”®å’Œèšåˆå‡½æ•°

next()æ“ä½œï¼š

ä¸æ–­è·å–ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œç›´åˆ°é‡è§ä¸åŒç»„çš„æ•°æ®

å½“ç¢°åˆ°æ–°çš„æŸä¸€ç»„æ•°æ®ï¼Œä¸”ä¸æ˜¯ç¢°åˆ°çš„ç¬¬ä¸€ä¸ªç»„æ—¶ï¼Œå®£å‘Šæœ¬è½®åˆ†ç»„å®Œæˆï¼Œç»“æœåŒ…å«å½“å‰ç»„ä»¥åŠèšåˆå‡½æ•°çš„ç»“æœã€‚è‹¥æ˜¯ç¢°åˆ°çš„ç¬¬ä¸€ä¸ªç»„ï¼Œå°±è·å–å¯¹åº”åˆ†ç»„å¹¶å¼€å§‹èšåˆå‡½æ•°çš„è®¡ç®—ã€‚



![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220630221951.png)

ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æŸ¥è¯¢æµç¨‹ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦å°†è¾“å‡ºçš„æ•°æ®å­˜å‚¨åˆ°ç£ç›˜ã€‚æ‰€æœ‰è¿­ä»£å™¨çš„æ“ä½œç»“æœéƒ½ä¼šä½œä¸ºä¸Šä¸€å±‚çš„å‚æ•°ç»§ç»­å‚ä¸è¿ç®—ï¼Œå…ƒç»„æµåªéœ€è¦ç•™å­˜åœ¨æ ˆä¸­ã€‚



## Join



### Simple Nested-Loop Join

ç®€å•åµŒå¥—å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ä»é©±åŠ¨è¡¨ä¸­è¯»å–ä¸€è¡Œæ•°æ®ï¼Œç„¶åæ‰«æä¸€éè¢«é©±åŠ¨è¡¨ï¼Œæ·»åŠ æ»¡è¶³æ¡ä»¶çš„æ•°æ®ã€‚

å‡è®¾é©±åŠ¨è¡¨Ræœ‰1000å¼ æ•°æ®é¡µï¼Œæ¯ä¸€é¡µæœ‰100æ¡æ•°æ®

è¢«é©±åŠ¨è¡¨Sæœ‰500å¼ æ•°æ®é¡µï¼Œæ¯ä¸€é¡µæœ‰80æ¡æ•°æ®

åˆ™å¼€é”€ä¸ºï¼š

æ‰«æä¸€éé©±åŠ¨è¡¨è¦1000æ¬¡IO(IOæ“ä½œçš„å•ä½ä¸ºæ•°æ®é¡µè€Œéè®°å½•)ï¼Œè€Œå¯¹äºRä¸­æ¯ä¸€æ¡è®°å½•ï¼Œéƒ½è¦æ‰«æä¸€éSè¡¨ï¼ŒIOæ¬¡æ•°ä¸º100000 * 500



PSï¼šè‹¥Sä¸ºé©±åŠ¨è¡¨ï¼Œå¼€é”€ä¸º500 + 40000 * 1000ï¼Œç›¸å¯¹å‡å°‘500æ¬¡IO



### Page Nested-Loop Join

å’ŒSNLç›¸æ¯”ï¼Œæ¯æ¬¡ä»é©±åŠ¨è¡¨ä¸­è·å–ä¸€é¡µæ•°æ®ï¼Œç„¶åä»è¢«é©±åŠ¨è¡¨è·å–ä¸€é¡µæ•°æ®ã€‚å°†è·å–çš„ä¸¤é¡µæ•°æ®å…ˆè¿›è¡Œä¸€æ¬¡Joinæ“ä½œã€‚

æ­¤æ—¶å¼€é”€é™ä½ä¸º 1000 + 1000 * 500(Rä¸ºé©±åŠ¨è¡¨)



æ¼”åŒ–ï¼šChunk Nested-Loop Join

ä¸€æ¬¡IOä»é©±åŠ¨è¡¨ä¸­è·å–å‡ é¡µæ•°æ®ï¼Œå…¶ä½™æ“ä½œåŒä¸Šã€‚

å¼€é”€å¯é™ä½ä¸º 1000 + (1000 / N) * 500 Nä¸ºä¸€æ¬¡æ€§è·å–çš„é¡µæ•°ï¼Œä¸€èˆ¬ä¸ºç¼“å†²åŒºæ•°-2ï¼Œç•™ä¸¤ä¸ªç¼“å†²åŒºä½œä¸ºSè¡¨çš„è¯»å…¥ä¸è¾“å‡ºï¼Œå‰©ä¸‹çš„ç¼“å†²åŒºéƒ½å»è¯»å–Rè¡¨ä¸­çš„æ•°æ®



### Index Nested-Loop Join

é©±åŠ¨è¡¨åœ¨æ‹¿åˆ°æ•°æ®åï¼Œç›´æ¥æ ¹æ®å…³è”å­—æ®µçš„ç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾ã€‚å’Œä¸Šè¿°çš„æ–¹æ³•ç›¸æ¯”ï¼Œè¯¥æ–¹æ³•æ¯ä»é©±åŠ¨è¡¨å–å‡ºä¸€æ¡è®°å½•ï¼Œéƒ½åªè¦å»æŸ¥è¯¢è¢«é©±åŠ¨è¡¨çš„ç´¢å¼•ï¼ŒæŸ¥è¯¢æ¬¡æ•°ä¸ºç´¢å¼•çš„é«˜åº¦ã€‚

å¼€é”€ä¸ºï¼šé©±åŠ¨è¡¨é¡µæ•° + é©±åŠ¨è¡¨è®°å½•æ•° * ç´¢å¼•æ ‘é«˜åº¦



### Sort-Merge Join

æ¡ä»¶ï¼šæœ‰ç›¸åŒå­—æ®µ(è‡ªç„¶è¿æ¥)æˆ–æŒ‡å®šçš„åˆ¤å®šæ¡ä»¶

æ­¥éª¤ï¼š

1. å°†é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨æŒ‰ç…§join keyæ’åº
2. å½’å¹¶æ‰«ææ’åºåçš„è¡¨å¹¶æå–å‡ºæ»¡è¶³æ¡ä»¶çš„å…ƒç»„

```C
do {
  if (!mark) {
    while (r < s) { advance r }
    while (r > s) { advance s }
    // mark start of â€œblockâ€ of S
    mark = s
  }
  if (r == s) {
    result = <r, s>
    advance s
    return result
  }
  else {
    reset s to mark
    advance r
    mark = NULL
  }
} while(r)
```

å¼€é”€ï¼šRå’ŒSæ’åºçš„IOå¼€é”€ï¼ŒåŠ ä¸Šå½’å¹¶æ—¶ï¼Œè¯»å–ä¸€éRå’ŒSçš„å¼€é”€



### Grace Hash Join

ä¸SNLçš„åŒºåˆ«ä»…ä¸ºé¢„å¤„ç†é˜¶æ®µã€‚

å°†Rè¡¨æ˜ å°„åˆ°B-1ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºçš„é¡µæ•°éƒ½<=B-2ï¼Œç„¶åå°†Rè¡¨çš„å„ä¸ªåˆ†åŒºéƒ½è¯»è¿›å†…å­˜å»ºç«‹å“ˆå¸Œæ˜ å°„ï¼Œç„¶åå°†Sè¡¨è¯»å…¥å¹¶è¿›è¡ŒåŒ¹é…ã€‚

ä»¥ä¸Šçš„åšæ³•ä¼šå¯¼è‡´ç£ç›˜æ‰«ææ¬¡æ•°è¿‡å¤šï¼Œæ— æ³•èµ·åˆ°å‡å°å¼€é”€çš„ç›®çš„ã€‚

Grace Hash Joinçš„æ“ä½œï¼š

1. å°†ä¸¤å¼ è¡¨æŒ‰ç…§åŒä¸€ä¸ªå“ˆå¸Œå‡½æ•°åˆ†é…åˆ°ä¸åŒçš„åˆ†ç‰‡ä¸­ï¼Œå¾—åˆ°B-1ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºç”±ä¸¤å¼ è¡¨ç»„æˆRi,Sj(Rå’ŒSçš„å­è¡¨)
2. é’ˆå¯¹æ¯ä¸€ä¸ªåˆ†åŒºï¼Œå°†ä¸€å¼ è¡¨è¯»å…¥å†…å­˜ï¼Œå»ºç«‹å“ˆå¸Œè¡¨ï¼Œç„¶åè¯»å–å¦ä¸€å¼ è¡¨è¿›è¡ŒåŒ¹é…ã€‚

å¦‚æœåˆ†åŒºåä»ç„¶æ— æ³•è£…å…¥å†…å­˜ï¼Œåˆ™é€’å½’è¿›è¡Œè¿›ä¸€æ­¥åˆ†åŒºã€‚



## Parallel Query

### å¹¶è¡Œæ¶æ„

1. å…±äº«å†…å­˜

   ![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709152532.png)

2. å…±äº«ç£ç›˜

   ![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709152604.png)

3. æ— å…±äº«

   ![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709152629.png)

æœ¬ç« ä¸»è¦ä»‹ç»æ— å…±äº«æ¶æ„çš„æ•°æ®åº“ã€‚



### å¹¶è¡Œçš„ç§ç±»

1. Intra-query parallel

   ä¸åŒçš„çº¿ç¨‹æ‰§è¡ŒæŸä¸€ä¸ªå•ä¸€çš„æŸ¥è¯¢

2. Inter-query parallel

   å•ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ‰§è¡Œè®¸å¤šä¸åŒçš„æŸ¥è¯¢æˆ–äº‹åŠ¡ã€‚



### æ•°æ®åˆ’åˆ†

ç”±äºæ— å…±äº«æ•°æ®åº“ä¸­çš„æ•°æ®åˆ†æ•£åœ¨ä¸åŒçš„æœºå™¨ï¼Œå› æ­¤è‰¯å¥½çš„åˆ’åˆ†ç­–ç•¥å¯ä»¥å¤§å¹…æå‡æ£€ç´¢æ•ˆç‡ã€‚

1. Range

   æ‰€æœ‰çš„æ•°æ®æ ¹æ®èŒƒå›´åˆ†å¸ƒåˆ°ä¸åŒçš„å­˜å‚¨å™¨ä¸Šã€‚é€‚åˆåšç­‰å€¼è¿æ¥ï¼ŒèŒƒå›´æŸ¥è¯¢ï¼Œåˆ†ç»„ã€‚

2. Hash

   é€šè¿‡å“ˆå¸Œç¡®å®šæ•°æ®æ‰€å¤„çš„åˆ†ç»„ã€‚é€‚åˆç­‰å€¼è¿æ¥ï¼Œåˆ†ç»„ã€‚

3. Round-Robin

   è½®è¯¢ç­–ç•¥ï¼Œå¯ä»¥æœ‰æ•ˆåœ°åˆ†æ•£è´Ÿè½½ã€‚



Lookup by key

å¦‚æœæ•°æ®ä¾æ®é”®åˆ†å¸ƒï¼Œåˆ™å¯ä»¥ç›´æ¥æ£€ç´¢åˆ°ç›¸å…³çš„ç»“ç‚¹ã€‚(Range, Hash)

å¦åˆ™å°±å¿…é¡»å¹¿æ’­æŸ¥è¯¢æ‰€æœ‰çš„ç»“ç‚¹ã€‚(Round Robin)

æ’å…¥é”®å€¼æˆ–æœ‰å”¯ä¸€æ€§çº¦æŸçš„é”®ä¹Ÿç±»ä¼¼ã€‚



### Parallel Join



#### Parallel Grace Hash Join

1. é¦–å…ˆå°†æ‰€æœ‰çš„æ•°æ®åˆ©ç”¨å“ˆå¸Œå‡½æ•°hnï¼Œåˆ†å¸ƒåˆ°ä¸åŒçš„æœºå™¨ä¸Šå»ã€‚
2. ç­‰åˆ°ç¬¬1æ­¥å®Œæˆåï¼Œæ¯å°æœºå™¨éƒ½åœ¨æœ¬æœºå¯¹å¾—åˆ°çš„æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥çš„Hashæ“ä½œã€‚
3. æ¯å°æœºå™¨å®ŒæˆHashåï¼Œè¿›è¡Œ GHJ

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709163827.png)

æ•´ä¸ªè¿‡ç¨‹åªæœ‰ç¬¬ä¸€æ­¥éœ€è¦æœºå™¨ç­‰å¾…æ•°æ®åˆ†å‘å®Œæ¯•ï¼Œå…¶ä»–æ—¶åˆ»éƒ½ä¸å­˜åœ¨ç­‰å¾…ï¼Œå› æ­¤æ•ˆç‡ä¼šæ¯”è¾ƒé«˜ã€‚



#### Parallel Sort-Merge Join

Pass 0ï¼šå°†æ•°æ®æŒ‰ç…§èŒƒå›´ä¼ é€åˆ°æŒ‡å®šçš„æœºå™¨ä¸Šå»ã€‚

èŒƒå›´é€‰å–æ–¹å¼ï¼šæ ¹æ®è¾“å…¥è·å–æ ·æœ¬ï¼Œå¹¶æ ¹æ®æ¯ä¸ªèŒƒå›´å†…çš„æ•°æ®é‡è¿›è¡Œåˆ†å‰²ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¢‘ç‡é«˜çš„åŒºé—´ï¼ŒèŒƒå›´å°ï¼Œç¡®ä¿æ•°æ®åœ¨æ¯å°æœºå™¨ä¸Šå¹³å‡åˆ†å¸ƒã€‚

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709165057.png)

Pass 1ï¼šåœ¨æ¯å°æœºå™¨ä¸Šè¿›è¡ŒSort-Merge Joinæ“ä½œ

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709165303.png)





#### Symmetric Hash join

æ— è®ºæ˜¯Hash joinè¿˜æ˜¯Sort Merge Joinéƒ½æœ‰ä¸€ä¸ªç­‰å¾…åŒæ­¥çš„è¿‡ç¨‹ã€‚ä½†Symmetric Hash Joinå¯ä»¥åšåˆ°æ•´ä¸ªJoinè¿‡ç¨‹æ²¡æœ‰ä»»ä½•ç­‰å¾…ï¼Œä¸”å…¨ç¨‹åªéœ€è¦æµå¼ä¼ è¾“ã€‚

è¿™ç§Joinæ–¹å¼è®©æ¯å°æœºå™¨éƒ½ä¸ºé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨å„ç»´æŠ¤ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œæ¯å½“ä¸€ä¸ªæ•°æ®åˆ°æ¥ï¼Œå°±å°†å…¶æ·»åŠ åˆ°å¯¹åº”è¡¨çš„å“ˆå¸Œè¡¨ä¸­ï¼Œç„¶åè®©è¯¥æ•°æ®å»æ¢ç´¢å¦ä¸€å¼ è¡¨çš„å“ˆå¸Œè¡¨ï¼Œå¯»æ‰¾å¯ä»¥åŒ¹é…çš„è®°å½•å¹¶è¾“å‡ºã€‚

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709171615.png)



#### One-side shuffle Join

å¦‚æœRè¡¨æœ¬èº«å·²ç»è¢«åˆç†åœ°åˆ’åˆ†äº†ï¼Œå°±åªåˆ’åˆ†Sè¡¨ï¼Œç„¶ååœ¨æ¯å°æœºå™¨ä¸Šè¿›è¡Œjoinå¹¶åˆå¹¶ç»“æœã€‚

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709172320.png)



#### Broadcast Join

å¦‚æœRè¡¨å¾ˆå°ï¼Œé‚£å°±å°†å®ƒä¼ é€ç»™æ¯ä¸€ä¸ªè·å¾—Sè¡¨åˆ†å—çš„æœºå™¨ä¸Š

![](https://raw.githubusercontent.com/FaustProMaxPX/pic_repository/main/img/database20220709172436.png)
